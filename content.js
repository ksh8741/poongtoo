(function () {
  'use strict';
  const STORAGE_KEY = 'poong_donation_by_date';
  const POS_KEY = 'poong_ui_position';

  (function migrateToChromeStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
  
      const parsed = JSON.parse(raw);
  
      chrome.storage.local.get(STORAGE_KEY, res => {
        if (res && res[STORAGE_KEY]) {
          console.log('[Poong] üîç Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï®, Î∂àÌïÑÏöî');
          return;
        }
  
        chrome.storage.local.set({ [STORAGE_KEY]: parsed }, () => {
          console.log('[Poong] ‚úÖ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏôÑÎ£å');
  
          // ‚úÖ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏôÑÎ£å ÌõÑ ÌôïÏù∏
          chrome.storage.local.get(STORAGE_KEY, r => {
            if (r && r[STORAGE_KEY]) {
              console.log('[Poong] üîç chrome.storage.localÏóê Ï†ÄÏû•Îêú ÎÇ¥Ïö©:', r[STORAGE_KEY]);
            } else {
              console.warn('[Poong] ‚ùå chrome.storage.localÏóê Í∞í ÏóÜÏùå');
            }
          });
        });
      });
    } catch (e) {
      console.warn('[Poong] ‚ö† ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïã§Ìå®:', e);
    }
  })();

  const today = new Date();
  const nowY = today.getFullYear();
  const nowM = today.getMonth() + 1;
  const nowD = today.getDate();

  async function clickMoreUntilDone() {
    while (true) {
      const btn = [...document.querySelectorAll('button')].find(el => el.textContent.includes('ÎçîÎ≥¥Í∏∞') && el.offsetParent !== null);
      if (!btn || btn.disabled || btn.style.display === 'none') break;
      btn.click();
      await new Promise(r => setTimeout(r, 100));
    }
    await new Promise(r => setTimeout(r, 1000));
  }

  function getCurrentDate() {
    const inp = document.querySelector('input.react-datepicker-ignore-onclickoutside, .react-datepicker__input-container input');
    if (inp && inp.value.trim()) return inp.value.trim();
  
    const spans = [...document.querySelectorAll('.react-dropdown-select-content span')];
    if (spans.length >= 2) {
      const y = spans[0].innerText.trim();
      const m = spans[1].innerText.trim().padStart(2, '0');
      if (/^\d{4}$/.test(y) && /^\d{2}$/.test(m)) return `${y}.${m}`;
    }
  
    const m3 = document.body.innerText.match(/(\d{4})\.(\d{2})\.(\d{2})/);
    if (m3) return `${m3[1]}.${m3[2]}.${m3[3]}`;
  
    return 'Unknown';
  }

  function sortedKeys(obj) {
    const daily = [];
    const monthly = [];
  
    for (const key of Object.keys(obj)) {
      if (/\s/.test(key)) continue; // ‚úÖ ÎùÑÏñ¥Ïì∞Í∏∞ Ìè¨Ìï®Îêú ÌÇ§Îäî Î¨¥Ïãú
  
      if (/^\d{4}\.\d{2}\.\d{2}$/.test(key)) {
        daily.push(key);
      } else if (/^\d{4}\.\d{2}$/.test(key)) {
        monthly.push(key);
      }
    }
  
    daily.sort((a, b) => new Date(b) - new Date(a));
    monthly.sort((a, b) => new Date(b) - new Date(a));
  
    return [...daily, ...monthly];
  }

  function extractPoongData() {
    const rows = document.querySelectorAll('li.row');
    const dataMap = {};
  
    rows.forEach((row) => {
      const href = row.querySelector('a.post')?.getAttribute('href') || '';
      const rawId = href.split('/').pop();
      const userId = rawId.replace(/\(\d+\)$/, '').trim();
      const nickEls = row.querySelectorAll('span.nick');
      const nickname = nickEls[0]?.innerText.trim() || '';
      const cols = row.querySelectorAll('div.col');
      const totalStars = parseInt((cols[0]?.innerText || '0').replace(/,/g, '')) || 0;
  
      const topBJRaw = nickEls[1]?.innerText || '';
      const topBJ = topBJRaw
        .replace(/live/gi, '')
        .replace(/\[.*?\]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
  
      const timesRaw = cols[1]?.innerText.trim() || '0';
      const bjsRaw   = cols[2]?.innerText.trim() || '0';
      const totalTimes = /^\d/.test(timesRaw) ? parseInt(timesRaw) : 0;
      const totalBJs   = /^\d/.test(bjsRaw)   ? parseInt(bjsRaw)   : 0;
  
      if (!dataMap[userId]) {
        dataMap[userId] = {
          userId,
          nickname,
          totalStars,
          totalTimes,
          totalBJs,
          topBJ
        };
      } else {
        dataMap[userId].totalStars += totalStars;
        dataMap[userId].totalTimes += totalTimes;
        dataMap[userId].totalBJs   += totalBJs;
      }
    });
  
    // ‚≠ê Ï†ïÎ†¨ + ÏàúÏúÑ(rank) Î∂ÄÏó¨
    const result = Object.values(dataMap)
      .sort((a, b) => b.totalStars - a.totalStars)
      .map((item, i) => ({
        ...item,
        rank: i + 1,
        totalStars: item.totalStars.toLocaleString(),  // ‚Üê ÏΩ§Îßà Ï≤òÎ¶¨
        totalTimes: item.totalTimes.toLocaleString(),
        totalBJs: item.totalBJs.toLocaleString()
      }));
    
    return result;
  }

  function renderRows(list, keyword = '', minStar = 0) {
    return list.filter(d => {
      const stars = d.totalStars ?? '';
      const cleanStars = typeof stars === 'string' ? stars.replace(/,/g, '') : '';
      return (!keyword || d.userId.includes(keyword) || d.nickname.includes(keyword) || d.topBJ.includes(keyword)) &&
             (!minStar || parseInt(cleanStars) >= minStar);
    }).map(d => `
      <tr style="border-bottom:1px solid #e2e8f0;">
        <td style="text-align:center;">${d.rank ?? ''}</td>
        <td><a href="https://bj.afreecatv.com/${d.userId ?? ''}" target="_blank" style="color:#0369a1;text-decoration:underline;">${d.userId ?? ''}</a></td>
        <td style="font-weight:bold">${d.nickname ?? ''}</td>
        <td style="font-weight:bold">${d.totalStars ?? ''}</td>
        <td>${d.totalTimes ?? ''}</td>
        <td>${d.totalBJs ?? ''}</td>
        <td>${d.topBJ ?? ''}</td>
      </tr>`).join('');
  }

  function getStorageSize() {
    return new Promise(resolve => {
      chrome.storage.local.get(STORAGE_KEY, res => {
        const obj = res[STORAGE_KEY] || {};
        const byteSize = new Blob([JSON.stringify(obj)]).size;
        const kb = (byteSize / 1024).toFixed(1);
        resolve(kb);
      });
    });
  }

  function filterAndSortKeys(data) {
    return Object.keys(data)
      .sort((a, b) => b.localeCompare(a));
  }

  function makeDraggable(panel, header) {
    let down = false, ox = 0, oy = 0;
    header.addEventListener('mousedown', e => {
      down = true; ox = e.clientX - panel.offsetLeft; oy = e.clientY - panel.offsetTop;
      e.preventDefault();
    });
    document.addEventListener('mouseup', () => {
      if (down) {
        localStorage.setItem(POS_KEY, JSON.stringify({ x: panel.offsetLeft, y: panel.offsetTop }));
      }
      down = false;
    });
    document.addEventListener('mousemove', e => {
      if (!down) return;
      panel.style.left = `${e.clientX - ox}px`;
      panel.style.top = `${e.clientY - oy}px`;
      panel.style.right = 'auto'; panel.style.bottom = 'auto';
    });
  }

  async function renderPoongUI(allData, selectedDate) {
    const old = document.getElementById('poong-ui');
    if (old) old.remove();
    const list = allData[selectedDate] || [];
    const pos = JSON.parse(localStorage.getItem(POS_KEY) || '{}');
  
    const box = document.createElement('div');
    box.id = 'poong-ui';
    box.style = `
      position:fixed; top:${pos.y||100}px; left:${pos.x||100}px; width:900px; height:600px;
      background:linear-gradient(to bottom right, #f8fafc, #e2e8f0); border:1px solid #cbd5e1;
      border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:999999;
      display:flex; flex-direction:column; font-family:'Segoe UI', sans-serif;`;  

      box.innerHTML = `
      <style>
        /* ‚îÄ‚îÄ Ï†ÑÏ≤¥ ÌÜ§ & Ìè∞Ìä∏ */
        #poong-ui{font-family:"Pretendard","Segoe UI",sans-serif;color:#111827}
    
        /* ÏÉÅÎã®/ÌïòÎã® Îë•Í∑º Î™®ÏÑúÎ¶¨ */
        #poong-header{background:#fff;color:#111827;border-bottom:1px solid #e5e7eb;
          box-shadow:0 1px 4px rgba(0,0,0,.05);border-top-left-radius:12px;border-top-right-radius:12px}
        #poong-ui>div:last-child{border-bottom-left-radius:12px;border-bottom-right-radius:12px}
    
        /* Î≤ÑÌäº Í≥µÌÜµ */
        #poong-ui button{font-size:13px;border:none;border-radius:8px;cursor:pointer;transition:.15s}
    
        /* ÏûÖÎ†• */
        #poong-ui input,#poong-ui select{border:1px solid #d1d5db;border-radius:8px;
          padding:6px 10px;background:#f9fafb;transition:.2s}
        #poong-ui input:focus,#poong-ui select:focus{border-color:#2563eb;outline:none;background:#fff}
    
        /* Ìëú */
        #poong-ui table{width:100%;border-collapse:collapse;font-size:13px;background:#fff;
          border-radius:12px;overflow:hidden}
        #poong-ui thead{background:#f3f4f6}
        #poong-ui th{padding:10px 6px;font-weight:600;color:#475569;position:sticky;top:0;z-index:1;background:#f3f4f6}
        #poong-ui td{padding:10px 6px;border-bottom:1px solid #f1f5f9}
        #poong-ui tr:hover td{background:#f9fafb}
        #poong-ui td:nth-child(3),#poong-ui td:nth-child(4){font-weight:600}
        #poong-ui a{color:#2563eb;text-decoration:none}
        #poong-ui a:hover{text-decoration:underline}
      </style>
    
      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Ìó§Îçî ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="poong-header"
          style="position:relative;padding:14px 20px;display:flex;align-items:center;cursor:move;">
        <span style="font-size:18px;font-weight:700;">üê∑ ÏöîÎãù ÌÅ∞ÏÜêÍ∞êÏßÄÍ∏∞</span>

        <!-- Ïö©Îüâ ÌëúÏãú: Ïò§Î•∏Ï™ΩÏúºÎ°ú Î∂ôÏù¥Îêò X Î≥¥Îã§ ÏïΩÍ∞Ñ ÏôºÏ™Ω -->
        <span id="storage-size"
              style="margin-left:auto; margin-right:40px; margin-top:-10wpx;
                    font-size:12px; color:#6b7280;">
          Í≥ÑÏÇ∞ Ï§ë...
        </span>

        <!-- X Î≤ÑÌäº: Ìï≠ÏÉÅ Ïö∞Ï∏° ÏÉÅÎã® Í≥†Ï†ï -->
        <button id="poong-close"
                style="position:absolute;top:10px;right:20px;background:none;border:none;
                      font-size:18px;cursor:pointer;">‚úï</button>
      </div>
    
      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Ìà¥Î∞î ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div style="padding:14px 20px;display:flex;align-items:center;gap:8px;background:#f8fafc;">
        <!-- üìÖ ÎÇ†Ïßú Î≤ÑÌäº -->
        <button id="date-label" style="height:32px;padding:0 14px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;display:flex;align-items:center;gap:4px;font-size:14px;">
          üìÖ ÎÇ†Ïßú
        </button>
    
        <!-- ÎÇ†Ïßú ÎìúÎ°≠Î∞ïÏä§ + ÌôîÏÇ¥Ìëú -->
        <div style="display:flex;align-items:center;gap:6px;">
          <select id="date-select" style="height:32px;width:110px;min-width:120px;max-width:110px;padding:4px 10px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;appearance:auto;"></select>
          <div style="display:flex;flex-direction:column;gap:2px;">
            <button id="date-up"   style="height:15px;width:24px;font-size:10px;border:1px solid #d1d5db;border-radius:4px;background:#fff;cursor:pointer;">‚ñ≤</button>
            <button id="date-down" style="height:15px;width:24px;font-size:10px;border:1px solid #d1d5db;border-radius:4px;background:#fff;cursor:pointer;">‚ñº</button>
          </div>
        </div>
    
        <!-- Í∞±Ïã† / ÏÇ≠Ï†ú -->
        <button id="refresh-btn" title="Í∞±Ïã†"
          style="height:32px;width:32px;border-radius:8px;border:1px solid #2563eb;background:#fff;color:#2563eb;font-size:16px;">
          ‚ôªÔ∏è
        </button>
        <button id="erase-btn" title="ÏÇ≠Ï†ú"
          style="height:32px;width:32px;margin-left:6px;border-radius:8px;border:1px solid #ef4444;background:#fff;color:#ef4444;font-size:16px;">
          üóëÔ∏è
        </button>
        
        <!-- ÎÇ¥Î≥¥ÎÇ¥Í∏∞ & Î∂àÎü¨Ïò§Í∏∞ ÏïÑÏù¥ÏΩò Î≤ÑÌäº -->
        <button id="export-btn" title="ÎÇ¥Î≥¥ÎÇ¥Í∏∞"
          style="height:32px;width:32px;margin-left:6px;border-radius:8px;border:1px solid #22c55e;background:#fff;color:#22c55e;font-size:16px;">
          üíæ
        </button>
        <button id="import-btn" title="Î∂àÎü¨Ïò§Í∏∞"
          style="height:32px;width:32px;margin-left:4px;border-radius:8px;border:1px solid #0ea5e9;background:#fff;color:#0ea5e9;font-size:16px;">
          üìÇ
        </button>

        <button id="reset-btn" title="Ï¥àÍ∏∞Ìôî"
          style="height:32px;width:32px;margin-left:4px;border-radius:8px;border:1px solid #ef4444;background:#fff;color:#ef4444;font-size:16px;">
          üîÑ
        </button>
        
        <!-- Ïò§Î•∏Ï™Ω ÏòÅÏó≠ (autoÎ°ú Î∞ÄÏñ¥ÎÉÑ) -->
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
          <!-- ‚ùî ÎèÑÏõÄÎßê -->
          <div id="filter-help-wrap" style="position:relative;display:inline-block;">
            <button class="poong-help-btn-main" style="
              width:25px;height:25px;font-size:15px;font-weight:bold;
              border-radius:50%;border:1px solid #d1d5db;background:#f9fafb;color:#6b7280;
              cursor:default;line-height:1;">?</button>
            <div class="poong-help-tooltip-main" style="
              visibility:hidden;opacity:0;transition:all 0.2s;
              position:absolute;top:30px;left:0;
              background:#1f2937;color:#fff;font-size:13px;line-height:1.5;
              padding:10px 14px;border-radius:8px;min-width:200px;max-width:280px;
              box-shadow:0 4px 12px rgba(0,0,0,0.2);white-space:normal;z-index:10000;">
              Í∏∞Í∞ÑÎ≥Ñ Ìï©ÏÇ∞ Î∞è ÌïÑÌÑ∞ Í∏∞Îä• ÏÇ¨Ïö© Ïãú<br>Îç∞Ïù¥ÌÑ∞ Î°úÎî©ÏúºÎ°ú Ïù∏Ìï¥ ÏùºÏãúÏ†ÅÏúºÎ°ú<br>Î†âÏù¥ Î∞úÏÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.
            </div>
          </div>
    
          <!-- ‚òÖ ÌïÑÌÑ∞ -->
          <input id="filter-star" type="number" placeholder="‚òÖ" style="height:32px;width:120px;padding:0 10px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;">
    
          <!-- ÎãâÎÑ§ÏûÑ ÌïÑÌÑ∞ -->
          <input id="filter-key" placeholder="ÎãâÎÑ§ÏûÑ / ID / BJ" style="height:32px;width:160px;padding:0 10px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;">
        </div>
      </div>
    
      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ÌÖåÏù¥Î∏î ÏòÅÏó≠ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div style="flex:1;padding:0 20px 20px;overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:48px;">ÏàúÏúÑ</th>
              <th style="width:140px;">ID</th>
              <th style="width:140px;">ÎãâÎÑ§ÏûÑ</th>
              <th style="width:90px;">Î≥ÑÌíçÏÑ†</th>
              <th style="width:70px;">ÌöüÏàò</th>
              <th style="width:70px;">Î∞©ÏÜ°</th>
              <th style="width:110px;">Ïï†Ï≤≠ Ïä§Ìä∏Î¶¨Î®∏</th>
            </tr>
          </thead>
          <tbody id="poong-table-body">${renderRows(list)}</tbody>
        </table>
      </div>
    `;

    setTimeout(() => {
      const btn = document.querySelector('.poong-help-btn-main');
      const tooltip = document.querySelector('.poong-help-tooltip-main');
      if (!btn || !tooltip) return;
      const wrap = btn.parentElement;
      wrap.onmouseenter = () => { tooltip.style.visibility='visible'; tooltip.style.opacity='1'; };
      wrap.onmouseleave = () => { tooltip.style.visibility='hidden'; tooltip.style.opacity='0'; };
    }, 200);
      
    // ÎÇ†Ïßú Î≥ÄÍ≤Ω Ìï®Ïàò
    function changeDate(offset) {
      const select = document.getElementById('date-select');
      const options = Array.from(select.options);
      const currentIndex = select.selectedIndex;
      const newIndex = currentIndex + offset;
      if (newIndex >= 0 && newIndex < options.length) {
        select.selectedIndex = newIndex;
        select.dispatchEvent(new Event('change', { bubbles: true }));
      }
    }

    document.body.appendChild(box);
    getStorageSize().then(size => {
      const el = document.getElementById('storage-size');
      if (el) el.textContent = `${size} KB`;
    });
    // üîºüîΩ ÌôîÏÇ¥Ìëú ÌÅ¥Î¶≠ ‚Üí ÎÇ†Ïßú Ïù¥Îèô
    document.getElementById('date-up')?.addEventListener('click', () => changeDate(-1));
    document.getElementById('date-down')?.addEventListener('click', () => changeDate(1));

    // üìÖ ÎÇ†Ïßú Î≤ÑÌäº ÌÅ¥Î¶≠ ‚Üí Î™®Îã¨ ÎùÑÏö∞Í∏∞
    document.getElementById('date-label')?.addEventListener('click', () => {
      const prev = document.getElementById('date-modal');
      if (prev) return; // ‚Üê Ïù¥ÎØ∏ ÏûàÏúºÎ©¥ Ï†úÍ±∞ (Ïïà Ïó¥Î¶¨Îäî Î≤ÑÍ∑∏ Î∞©ÏßÄ)

      const style = document.createElement('style');
      style.textContent = `
      .titlebar {
        font-weight: bold;
        font-size: 20px;
        background: #f87171;
        color: white;
        padding: 12px 20px;
        cursor: move;
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
        margin: -24px -24px 16px -24px;  /* ‚Üê Î™®Îã¨ ÏïàÏ™Ω Ïó¨Î∞±ÏùÑ Îö´Í≥† ÏÉÅÎã®Ïóê ÎßûÍ≤å Î∞∞Ïπò */
      }
    
      #date-modal .tooltip-msg {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s;
      }
    
      #date-modal div:hover > .tooltip-msg {
        visibility: visible !important;
        opacity: 1 !important;
      }
    `;
      document.head.appendChild(style);
    
      const modal = document.createElement('div');
      modal.id = 'date-modal';
        modal.style = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 24px;
        z-index: 9999999;
        width: 440px;
        font-family: 'Pretendard', sans-serif;
        cursor: move;
      `;
    
      modal.innerHTML = `
        <style>
          #date-modal button {
            font-size: 14px;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
          }
          #date-modal .range-btn {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
          }
          #date-modal #cancel-range {
            background: #e5e7eb;
            color: #111827;
          }
          #date-modal #confirm-range {
            background: #2563eb;
            color: white;
          }
        </style>
      
        <div style="display:flex; flex-direction:column; gap:4px; margin-bottom:16px;">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <div style="flex:1; display:flex; flex-direction:column; gap:6px;">
              <label for="range-start" style="font-size:12px; color:#6b7280;">ÏãúÏûëÏùº</label>
              <input type="date" id="range-start" style="padding:10px 12px; border:1px solid #d1d5db; border-radius:8px;">
            </div>
            <div style="flex:1; display:flex; flex-direction:column; gap:6px;">
              <label for="range-end" style="font-size:12px; color:#6b7280;">Ï¢ÖÎ£åÏùº</label>
              <input type="date" id="range-end" style="padding:10px 12px; border:1px solid #d1d5db; border-radius:8px;">
            </div>
          </div>
        </div>
      
        <div style="display:flex; justify-content:space-between; gap:8px; margin-bottom:16px;">
          <button class="range-btn" data-range="1" style="flex:1;">ÌïòÎ£®</button>
          <button class="range-btn" data-range="7" style="flex:1;">ÏùºÏ£ºÏùº</button>
          <button class="range-btn" data-range="30" style="flex:1;">ÌïúÎã¨</button>
          <button class="range-btn" data-range="365" style="flex:1;">ÏùºÎÖÑ</button>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
          <button id="cancel-range">Ï∑®ÏÜå</button>
          <button id="confirm-range">Ï†ÅÏö©</button>
        </div>
        <!-- ‚ùî ÎèÑÏõÄÎßê ÏïÑÏù¥ÏΩò -->
        <div style="position: absolute; bottom: 12px; left: 16px;">
          <div style="position: relative; display: inline-block;">
            <div style="
              width: 26px; height: 26px;
              border-radius: 50%;
              background: #f3f4f6;
              border: 1px solid #d1d5db;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 16px;
              font-weight: bold;
              color: #6b7280;
              cursor: default;
            ">?</div>
            <div style="
              visibility: hidden;
              opacity: 0;
              width: max-content;
              max-width: 240px;
              background-color: #374151;
              color: #f9fafb;
              text-align: left;
              border-radius: 8px;
              padding: 10px 14px;
              position: absolute;
              z-index: 1;
              bottom: 34px;
              left: 0;
              font-size: 13px;
              line-height: 1.4;
              transition: opacity 0.3s;
              pointer-events: none;
            " class="tooltip-msg">
              Îëê Îã¨ Ïù¥Ï†ÑÏùò Îç∞Ïù¥ÌÑ∞Îäî ÏõîÎ≥Ñ 1ÏùºÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.<br>
              ÏÑ†ÌÉù ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎî©Ïóê ÏßÄÏó∞Ïù¥ Î∞úÏÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.
            </div>
          </div>
        </div>
      `;
      /* ---------- ÌÉÄÏù¥ÌãÄÎ∞î ÎßåÎì§Í≥† Îß® ÏúÑÏóê ÎÑ£Í∏∞ ---------- */
      const titlebar = document.createElement('div');
      titlebar.className = 'titlebar';
      titlebar.textContent = 'üìÖ Í∏∞Í∞Ñ ÏÑ†ÌÉù';
      modal.insertBefore(titlebar, modal.firstChild);

      document.body.appendChild(modal);  // ‚úÖ Î™®Îã¨ÏùÑ ÌôîÎ©¥Ïóê Î∂ôÏù¥Í≥†

      // ‚òÖ ÎÇ†Ïßú Ï†úÏïΩ ÏÑ§Ï†ï ‚îÄ‚îÄ Ïó¨Í∏∞Î∂ÄÌÑ∞
      (() => {
        /* Í≥µÏö© Ìè¨Îß§ÌÑ∞ */
        const fmt = d => {
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, '0');
          const dd = String(d.getDate()).padStart(2, '0');
          return `${y}-${m}-${dd}`;
        };
      
        /* KST Ïò§Îäò 0Ïãú */
        const now   = new Date();
        const utc   = now.getTime() + now.getTimezoneOffset() * 60000;
        const today = new Date(utc + 9 * 60 * 60 * 1000);   // KST
        today.setHours(0, 0, 0, 0);
      
        /* ÌïúÍ≥Ñ Í≥ÑÏÇ∞ */
        const oldestAllowed   = new Date(today.getFullYear(), today.getMonth() - 13, 1); // 13Í∞úÏõî Ï†Ñ 1Ïùº
        const prevMonthFirst  = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const thisMonthFirst  = new Date(today.getFullYear(), today.getMonth(),     1);
      
        /* ÏûÖÎ†•‚ÄÜbox */
        const startInput = modal.querySelector('#range-start');
        const endInput   = modal.querySelector('#range-end');
      
        /* Í∏∞Î≥∏ min / max */
        [startInput, endInput].forEach(inp => {
          inp.min = fmt(oldestAllowed);
          inp.max = fmt(today);
        });
      
        /* ‚ÄúÏ†ÄÏ†ÄÎ≤àÎã¨ÏùÄ 1ÏùºÎßå‚Äù Í∑úÏπô + ÎØ∏Îûò/13 Í∞úÏõî Ï¥àÍ≥º Î∞©ÏßÄ */
        function validateAndClamp(inp) {
          if (!inp.value) return;
      
          const [y, m, d] = inp.value.split('-').map(Number);
          const kstDate   = new Date(y, m - 1, d);   // KST ÏûêÏ†ï Í∏∞Ï§Ä
      
          /* ‚ë† ÎØ∏Îûò Ï∞®Îã® */
          if (kstDate > today) {
            alert('ÎØ∏Îûò ÎÇ†ÏßúÎäî ÏÑ†ÌÉùÌï† Ïàò ÏóÜÏäµÎãàÎã§');
            inp.value = '';
            return;
          }
      
          /* ‚ë° 13Í∞úÏõî Ï¥àÍ≥º Ï∞®Îã® */
          if (kstDate < oldestAllowed) {
            alert('13Í∞úÏõîÏùÑ Ï¥àÍ≥ºÌïú ÎÇ†ÏßúÎäî ÏÑ†ÌÉùÌï† Ïàò ÏóÜÏäµÎãàÎã§');
            inp.value = '';
            return;
          }
      
          /* ‚ë¢ Ï†ÄÏ†ÄÎ≤àÎã¨Ïù¥Î©¥ 1ÏùºÎ°ú Í∞ïÏ†ú */
          if (kstDate < prevMonthFirst && kstDate.getDate() !== 1) {
            kstDate.setDate(1);
            inp.value = fmt(kstDate);
          }
        }
      
        startInput.addEventListener('change', () => {
          validateAndClamp(startInput);
          /* Ï¢ÖÎ£åÏùºÏùÄ ‚ÄÜ start Ïù¥ÏÉÅÎßå ÌóàÏö© */
          if (startInput.value) endInput.min = startInput.value;
        });
      
        endInput.addEventListener('change', () => {
          validateAndClamp(endInput);
        });
      
        /* Îã¨Î†• Ïó¥Î¶¥ ÎïåÎßàÎã§ min/max Ïû¨ÏÑ§Ï†ï (Ï†ÄÏ†ÄÎ≤àÎã¨ 1ÏùºÎßå ÎÖ∏Ï∂ú) */
        [startInput, endInput].forEach(inp => {
          inp.addEventListener('focus', () => {
            const [y, m] = fmt(today).split('-').map(Number);
      
            /* Í∏∞Î≥∏Í∞í: Ï†ÑÏ≤¥ ÌóàÏö© */
            inp.min = fmt(oldestAllowed);
            inp.max = fmt(today);
      
            /* Îã¨Î†•Ïù¥ Ï†ÄÏ†ÄÎ≤àÎã¨ ÌéòÏù¥ÏßÄÎ°ú Ïó¥Î¶¨Î©¥ Í∑∏ Îã¨Ïùò 1ÏùºÎßå ÏÑ†ÌÉù */
            const shownYear  = Number(inp.value.slice(0, 4)) || y;
            const shownMonth = Number(inp.value.slice(5, 7)) || m;
            const shownFirst = new Date(shownYear, shownMonth - 1, 1);
      
            if (shownFirst < prevMonthFirst) {
              const only  = fmt(shownFirst);
              inp.min = inp.max = only;
            }
          });
        });
      })();
      // ‚òÖ ÎÇ†Ïßú Ï†úÏïΩ ÏÑ§Ï†ï ‚îÄ‚îÄ Ïó¨Í∏∞ÍπåÏßÄ

      // ‚úÖ Í≥ßÎ∞îÎ°ú ÏïÑÎûòÏóê ÎìúÎûòÍ∑∏ Í∏∞Îä• Î∂ÄÏ∞©
      let drag = false, dx = 0, dy = 0;

      modal.addEventListener('mousedown', e => {
        if (!e.target.classList.contains('titlebar')) return;
        drag = true;
        dx = e.clientX - modal.offsetLeft;
        dy = e.clientY - modal.offsetTop;
      });
      
      document.addEventListener('mousemove', e => {
        if (!drag) return;
        modal.style.left = e.clientX - dx + 'px';
        modal.style.top = e.clientY - dy + 'px';
      });
      
      document.addEventListener('mouseup', () => drag = false);

      // Î≤ÑÌäº ÎÇ†Ïßú ÏûêÎèô Ï±ÑÏö∞Í∏∞
      modal.querySelectorAll('.range-btn').forEach(btn => {
        btn.onclick = () => {
          const days = parseInt(btn.dataset.range);
      
          // ‚úÖ ÌïúÍµ≠ÏãúÍ∞Ñ (KST, UTC+9) Í∏∞Ï§ÄÏúºÎ°ú "Ï†ïÌôïÌïú ÎÇ†Ïßú" Í≥ÑÏÇ∞
          const nowUTC = new Date(Date.now() + 9 * 60 * 60 * 1000); // KST Î≥¥Ï†ï
          const today = new Date(nowUTC.getFullYear(), nowUTC.getMonth(), nowUTC.getDate()); // Ïò§Ï†Ñ 0Ïãú Í∏∞Ï§Ä
      
          const start = new Date(today);
          start.setDate(start.getDate() - days + 1);
      
          const format = (d) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${dd}`;
          };
      
          modal.querySelector('#range-start').value = format(start);
          modal.querySelector('#range-end').value = format(today);
        };
      });
    
      // Ï†ÅÏö© ÌÅ¥Î¶≠
      modal.querySelector('#confirm-range').onclick = () => {
        const start = modal.querySelector('#range-start').value;
        const end   = modal.querySelector('#range-end').value;
        if (!start || !end) return alert('ÎÇ†ÏßúÎ•º Î™®Îëê ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
      
        let startDate = new Date(start);
        let endDate = new Date(end);
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
      
        if (startDate > endDate) return alert('ÏãúÏûëÏùºÏùÄ Ï¢ÖÎ£åÏùºÎ≥¥Îã§ ÏïûÏÑúÏïº Ìï©ÎãàÎã§');
      
        let dayKeys = Object.keys(allData)
          .filter(k => {
            const clean = k.replace(/\s/g, '');
            const parts = clean.split('.');
            if (parts.length < 2) return false;
            const y = parseInt(parts[0]), m = parseInt(parts[1]), d = parts[2] ? parseInt(parts[2]) : 1;
            if (!y || !m) return false;
            const date = new Date(y, m - 1, d);
            return date >= startDate && date <= endDate;
          })
          .sort((a, b) => new Date(a.replace(/\./g, '-')) - new Date(b.replace(/\./g, '-'))); // ÏµúÏã† ÎãâÎÑ§ÏûÑ ÌåêÎã®Ïö©
      
        const map = new Map();
        const latestNicknameMap = new Map(); // ID Í∏∞Ï§Ä ‚Üí ÏµúÏã† ÎãâÎÑ§ÏûÑ Ï†ÄÏû•
        const latestTopBJMap    = new Map();
      
        dayKeys.forEach(k => {
          const rows = allData[k] || [];
          rows.forEach(row => {
            const rawId = row.userId;
            const normalizedId = rawId.replace(/\(\d+\)$/, '').replace(/\s/g, '');
        
            if (!map.has(normalizedId)) {
              map.set(normalizedId, {
                ...row,
                userId: normalizedId, // IDÎäî Ï†ïÍ∑úÌôî
                totalStars: (row.totalStars || '0').toString().replace(/,/g, '').toLocaleString(),
                totalTimes: (row.totalTimes || '0').toString(),
                totalBJs: (row.totalBJs || '0').toString(),
              });
              latestNicknameMap.set(normalizedId, row.nickname);
              if (row.topBJ) latestTopBJMap.set(normalizedId, row.topBJ);
            } else {
              const existing = map.get(normalizedId);
        
              existing.totalStars = (
                +((existing.totalStars || '0').toString().replace(/,/g, '')) +
                +((row.totalStars || '0').toString().replace(/,/g, ''))
              ).toLocaleString();
        
              existing.totalTimes = (
                +(existing.totalTimes || 0) + +(row.totalTimes || 0)
              ).toString();
        
              existing.totalBJs = (
                +(existing.totalBJs || 0) + +(row.totalBJs || 0)
              ).toString();
        
              latestNicknameMap.set(normalizedId, row.nickname);
              if (row.topBJ) latestTopBJMap.set(normalizedId, row.topBJ);
            }
          });
        });
      
        const mergedArr = Array.from(map.entries())
          .map(([id, data]) => ({
            ...data,
            userId: id,
            nickname: latestNicknameMap.get(id),
            topBJ:    latestTopBJMap.get(id) || '(ÏïåÏàòÏóÜÏùå)'
          }))
          .sort((a, b) => parseInt(b.totalStars.replace(/,/g, '')) -
                         parseInt(a.totalStars.replace(/,/g, '')))
          .map((r, i) => ({ ...r, rank: i + 1 }));
      
        const newData = { ...allData };
        newData['__merged__'] = mergedArr;           // ‚úÖ 'Îç∞Ïù¥ÌÑ∞ Ìï©ÏÇ∞'ÏúºÎ°ú Ï†ÄÏû•
        renderPoongUI(newData, '__merged__');
        modal.remove();
      };
      // Ï∑®ÏÜå
      modal.querySelector('#cancel-range').onclick = () => modal.remove();
    
    });
    const header = box.querySelector('#poong-header');
    makeDraggable(box, header);
    
    document.getElementById('poong-close').onclick = () => box.remove();

    // ‚úÖ ÎÇ†Ïßú ÎìúÎ°≠Îã§Ïö¥ Îã§Ïãú Ï±ÑÏö∞Í∏∞
    const dateSelect   = document.getElementById('date-select');
    const sortedDates  = sortedKeys(allData);

    dateSelect.innerHTML = '';

    const makeOpt = (val, label, sel = false) => {
      const o = document.createElement('option');
      o.value = val;
      o.textContent = label;
      if (sel) o.selected = true;
      return o;
    };

    // ‚îÄ‚îÄ 1) -ÏÑ†ÌÉù- ÏòµÏÖò: Ìï≠ÏÉÅ Îß® ÏúÑ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    dateSelect.appendChild(makeOpt('', '-ÏÑ†ÌÉù-', !selectedDate));

    // ‚îÄ‚îÄ 2) ÏùºÎ≥Ñ & ÏõîÎ≥Ñ ÎÇ†Ïßú ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    sortedDates.forEach(dateKey => {
      if (dateKey === '__merged__') return; // Î≥ÑÎèÑÎ°ú Ï≤òÎ¶¨
      const label = dateKey.replace('.json', '');
      const opt = makeOpt(dateKey, label, dateKey === selectedDate);
      dateSelect.appendChild(opt);
    });

    // ‚îÄ‚îÄ 3) Ìï©ÏÇ∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (allData['__merged__']) {
      dateSelect.appendChild(makeOpt('__merged__', 'Îç∞Ïù¥ÌÑ∞ Ìï©ÏÇ∞', selectedDate === '__merged__'));
    }

    // ‚úÖ Ïù¥Î≤§Ìä∏
    dateSelect.addEventListener('change', e => renderPoongUI(allData, e.target.value));
    
    const refresh = async () => {
      await clickMoreUntilDone();                   // ÌéòÏù¥ÏßÄ ‚ÄúÎçîÎ≥¥Í∏∞‚Äù Î™®Îëê ÌÅ¥Î¶≠
    
      const rawDate = getCurrentDate();             // ex) "2025.07.08"
      const d = rawDate.replace(/\s/g, '');         // ÌòπÏãú Î™®Î•º Í≥µÎ∞± Ï†úÍ±∞
    
      const rawData = extractPoongData();
      let newData;
    
      if (/^\d{4}\.\d{2}$/.test(d)) {               // ÏõîÎ≥Ñ: ÏµúÏÜå Ï†ïÎ≥¥Îßå Ï†ÄÏû•
        newData = rawData.map((r, i) => ({
          rank: i + 1,
          userId: r.userId,
          nickname: r.nickname,
          topBJ: r.topBJ,
        }));
      } else {                                      // ÏùºÎ≥Ñ: Ï†ÑÏ≤¥ Ï†ïÎ≥¥ Ï†ÄÏû•
        newData = rawData.map((r, i) => ({
          rank: i + 1,
          userId: r.userId,
          nickname: r.nickname,
          totalStars: r.totalStars || '',
          totalTimes: r.totalTimes || '',
          totalBJs:  r.totalBJs  || '',
          topBJ: r.topBJ,
        }));
      }
    
      /* ‚îÄ‚îÄ chrome.storage.local Ïóê Î≥ëÌï© Ï†ÄÏû• ‚îÄ‚îÄ */
      const store = await new Promise(r =>
        chrome.storage.local.get(STORAGE_KEY, res => r(res[STORAGE_KEY] || {}))
      );
      store[d] = newData;                            // Í≥µÎ∞± ÏóÜÎäî ÌÇ§Î°ú Ï†ÄÏû•
    
      chrome.storage.local.set({ [STORAGE_KEY]: store }, () => {
        renderPoongUI(store, d);                     // Í≥µÎ∞± ÏóÜÎäî ÌÇ§Î°ú UI Î†åÎçîÎßÅ
      });
    };
    
    document.getElementById('refresh-btn').onclick = refresh;

    document.getElementById('erase-btn').onclick = () => {
      chrome.storage.local.get([STORAGE_KEY], result => {
        const store = result[STORAGE_KEY] || {};
        if (!selectedDate || !store[selectedDate]) {
          alert('‚ùå ÏÇ≠Ï†úÌï† ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
          return;
        }
    
        delete store[selectedDate];
        chrome.storage.local.set({ [STORAGE_KEY]: store }, () => {
          const nextDate = sortedKeys(store)[0] || '';  
          selectedDate = nextDate;                      
          renderPoongUI(store, selectedDate);           
        });
      });
    };
    
    document.querySelector('#export-btn').onclick = async () => {
      const result = await new Promise(resolve =>
        chrome.storage.local.get(['poong_donation_by_date'], resolve)
      );
    
      const allData = result.poong_donation_by_date || {};
      const keys = Object.keys(allData);
    
      if (keys.length === 0) return;
    
      // ÎÇ†Ïßú Ï†ïÍ∑úÏãù ÌôïÏù∏ (ÎùÑÏñ¥Ïì∞Í∏∞ Ï†úÍ±∞Îêú YYYY.MM.DD ÎòêÎäî YYYY.MM)
      const isValidDate = date => /^\d{4}\.\d{2}(\.\d{2})?$/.test(date.replace(/\s/g, ''));
    
      for (const origKey of keys) {
        const cleanKey = origKey.replace(/\s/g, '');        // ÎùÑÏñ¥Ïì∞Í∏∞ Ï†úÍ±∞
        if (!isValidDate(cleanKey)) continue;
    
        const noDotKey = cleanKey.replace(/\./g, '');       // üî• Ï†ê Ï†úÍ±∞
    
        const data = allData[origKey];
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
    
        const a = document.createElement('a');
        a.href = url;
        a.download = `${noDotKey}.json`;                   // üî• Ï†ê Ï†úÍ±∞Îêú Ïù¥Î¶ÑÏúºÎ°ú Ï†ÄÏû•
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    
        // ‚úÖ 150ms ÎîúÎ†àÏù¥Î°ú ÏàúÏ∞® Ï†ÄÏû•
        await new Promise(r => setTimeout(r, 150));
      }
    };

    // ‚îÄ‚îÄ‚îÄ Ïó¨Îü¨ JSON ÌååÏùº(ÎòêÎäî Ìè¥Îçî) ÌïúÍ∫ºÎ≤àÏóê Î∂àÎü¨Ïò§Í∏∞ ‚îÄ‚îÄ‚îÄ
    document.querySelector('#import-btn').onclick = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.multiple = true;         // Îã§Ï§ë ÏÑ†ÌÉù
      input.webkitdirectory = true;  // Ìè¥ÎçîÏß∏ ÏÑ†ÌÉù Í∞ÄÎä•
    
      input.onchange = async e => {
        const files = Array.from(e.target.files)
          .filter(f => /\.json$/i.test(f.name));    // JSONÎßå ÌïÑÌÑ∞
    
        if (!files.length) return;
    
        // ‚ë† Í∏∞Ï°¥ Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
        const existing = await new Promise(resolve =>
          chrome.storage.local.get('poong_donation_by_date', res =>
            resolve(res.poong_donation_by_date || {})
          )
        );
    
        // ‚ë° ÏÉà ÌååÏùº Î≥ëÌï©
        for (const file of files) {
          try {
            const text = await file.text();
            const data = JSON.parse(text);
    
            // üîß ÌååÏùºÎ™ÖÏóêÏÑú ÌÇ§ Ï∂îÏ∂ú + Í≥µÎ∞±/Ï†ê Ï†úÍ±∞ ‚Üí YYYYMMDD ÌòïÏãùÏúºÎ°ú
            let key = file.webkitRelativePath
              ? file.webkitRelativePath.split('/').pop().replace(/\.json$/i, '')
              : file.name.replace(/\.json$/i, '');
    
            key = key.replace(/\s/g, '').replace(/\./g, '');  // ÎùÑÏñ¥Ïì∞Í∏∞ Î∞è Ï†ê Ï†úÍ±∞
    
            // üîí ÌÇ§ Ìè¨Îß∑ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨: YYYYMM ÎòêÎäî YYYYMMDD Îßå ÌóàÏö©
            if (!/^\d{6}(\d{2})?$/.test(key)) {
              console.warn(`‚ùå Î¨¥ÏãúÎê®: ÏûòÎ™ªÎêú ÎÇ†Ïßú ÌòïÏãù ‚Üí ${file.name}`);
              continue;
            }
    
            existing[key] = data;  // Î≥ëÌï© ÎòêÎäî ÎçÆÏñ¥Ïì∞Í∏∞
    
          } catch (err) {
            console.warn(`‚ùå ${file.name} ÌååÏã± Ïã§Ìå®`, err);
          }
        }
    
        // ‚ë¢ Î≥ëÌï© Ï†ÄÏû• ÌõÑ UI Í∞±Ïã†
        chrome.storage.local.set({ poong_donation_by_date: existing }, () => {
          const latest = Object.keys(existing).sort().reverse()[0] || '';  // ÏµúÏã† ÎÇ†Ïßú Í∏∞Ï§Ä
          renderPoongUI(existing, latest);               // ÏÉàÎ°úÍ≥†Ïπ® ÏóÜÏù¥ Î†åÎçîÎßÅ
          alert(`‚úÖ ${files.length}Í∞ú ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§!`);
        });
      };
    
      input.click();
    };

    document.getElementById('reset-btn').onclick = () => {
      const confirmed = confirm('‚ö†Ô∏è Î™®Îì† ÌõÑÏõê Îç∞Ïù¥ÌÑ∞Î•º ÏôÑÏ†ÑÌûà ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.');
      if (!confirmed) return;
    
      chrome.storage.local.set({ [STORAGE_KEY]: {} }, () => {
        selectedDate = '';
        renderPoongUI({}, '');
        alert('‚úÖ Î™®Îì† ÌõÑÏõê Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
      });
    };

    const doFilter = () => {
      const key = document.getElementById('filter-key').value.trim();
      const star = parseInt(document.getElementById('filter-star').value.trim()) || 0;
      document.getElementById('poong-table-body').innerHTML = renderRows(list, key, star);
    };
    
    document.getElementById('filter-key').onkeydown = e => {
      if (e.key === 'Enter') doFilter();
    };
    document.getElementById('filter-star').onkeydown = e => {
      if (e.key === 'Enter') doFilter();
    };
  }

  async function loadAllDateFiles() {
    try {
      const indexUrl  = chrome.runtime.getURL("index.json");
      const indexRes  = await fetch(indexUrl);
      const indexJson = await indexRes.json();           // { files: [...] }
      const files     = indexJson.files || [];
  
      const map = {};
      for (const file of files) {
        const fileUrl = chrome.runtime.getURL(`date/${file}`);
        try {
          const res = await fetch(fileUrl);
          if (!res.ok) throw new Error("404");
          const data = await res.json();
  
          // üîß ÌååÏùºÎ™ÖÏóêÏÑú ÌÇ§ Ï∂îÏ∂ú (ÌôïÏû•Ïûê Ï†úÍ±∞ + Í≥µÎ∞± Ï†úÍ±∞)
          const rawKey = file.replace(/\.json$/i, '');
          const key = rawKey.replace(/\s/g, '');
  
          // üîí ÎÇ†Ïßú ÌòïÏãù ÌôïÏù∏: YYYY.MM ÎòêÎäî YYYY.MM.DDÎßå ÌóàÏö©
          if (!/^\d{4}\.\d{2}(\.\d{2})?$/.test(key)) {
            console.warn(`[loadAllDateFiles] ‚ùå ÏûòÎ™ªÎêú ÌÇ§ ÌòïÏãù: ${rawKey}`);
            continue;
          }
  
          map[key] = data;
        } catch (e) {
          console.warn("[loadAllDateFiles] missing:", file);
        }
      }
      return map;
    } catch (err) {
      console.error("[loadAllDateFiles] failed:", err);
      return {};
    }
  }
  
  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ë° UI Ïó¥ Îïå ÏûêÎèô Î°úÎìú ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  window.showPoongUI = async function () {
    const dataMap = await loadAllDateFiles();  // ‚Üê date/* Î°úÎìú

    // ‚úÖ Ïú†Ìö®Ìïú ÎÇ†Ïßú ÌÇ§Îßå ÌïÑÌÑ∞
    const validKeys = Object.keys(dataMap).filter(key =>
      /^\d{4}\.\d{2}(\.\d{2})?$/.test(key)
    ).sort((a, b) => b.localeCompare(a));

    const latest = validKeys[0] || "";

    renderPoongUI(dataMap, latest);           // Í∏∞Ï°¥ Î†åÎçî Ìï®Ïàò Ïû¨ÏÇ¨Ïö©
  };
  const icon = document.createElement('div');
  icon.innerHTML = 'üê∑'; // ÏïÑÏù¥ÏΩò ÎÇ¥Ïö© Î∞îÍæ∏Í≥† Ïã∂ÏúºÎ©¥ Ïó¨Í∏∞
  Object.assign(icon.style, {
    position: 'fixed',
    bottom: '20px',
    right: '20px',
    width: '48px',
    height: '48px',
    background: 'white',
    borderRadius: '50%',
    boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    fontSize: '20px',
    fontWeight: 'bold',
    color: '#111827',
    cursor: 'pointer',
    zIndex: 2147483647,
    transition: 'all 0.2s ease',
  });
  icon.title = 'ÏöîÎãù ÌÅ∞ÏÜê ÏïåÎ¶¨ÎØ∏';
  icon.onmouseenter = () => icon.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25)';
  icon.onmouseleave = () => icon.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
  icon.onclick = window.showPoongUI;
  document.body.appendChild(icon);

/*==============Ïó¨Í∏∞ÏÑúÎ∂ÄÌÑ∞ ÏïåÎ¶ºÏÑ§Ï†ï================*/

// üîî ÏïåÎ¶º ÏïÑÏù¥ÏΩò ÏÉùÏÑ±
const alertIcon = document.createElement('div');
alertIcon.innerHTML = 'üîî';
Object.assign(alertIcon.style, {
  position: 'fixed',
  bottom: '80px',
  right: '20px',
  width: '48px',
  height: '48px',
  background: 'white',
  borderRadius: '50%',
  boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
  display: 'flex',
  alignItems: 'center',
  justifyContent: 'center',
  fontSize: '20px',
  fontWeight: 'bold',
  color: '#111827',
  cursor: 'pointer',
  zIndex: 2147483647,
  transition: 'all 0.2s ease',
});
alertIcon.title = 'ÏïåÎ¶º ÏÑ§Ï†ï Ïó¥Í∏∞';
alertIcon.onmouseenter = () => alertIcon.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25)';
alertIcon.onmouseleave = () => alertIcon.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
document.body.appendChild(alertIcon);

let alertPanel = null;
let alertUserList = [];

// üìå ÏïåÎ¶º ÏÑ§Ï†ï Ìå®ÎÑê ÌëúÏãú Ìï®Ïàò
function showAlertPanel() {
  if (!alertPanel) return;

  chrome.storage.local.get('poong_alert_config', ({ poong_alert_config }) => {
    const config = poong_alert_config || {};
    alertPanel.querySelector('#alert-enabled').checked = config.enabled || false;
    alertPanel.querySelector('#alert-start').value = config.start || '';
    alertPanel.querySelector('#alert-end').value = config.end || '';
    alertPanel.querySelector('#alert-stars').value = config.minStars || '';
    alertUserList = (config.manualIds || []);
    renderAlertTags();
  });

  alertPanel.style.display = 'block';
}

// üìå ÌÉúÍ∑∏ Î†åÎçîÎßÅ
function renderAlertTags() {
  const tagBox = alertPanel.querySelector('#alert-tags');
  tagBox.innerHTML = '';
  alertUserList.forEach((id, idx) => {
    const tag = document.createElement('div');
    tag.className = 'tag';
    tag.innerHTML = `${id}<button class="remove">√ó</button>`;
    tag.querySelector('button').onclick = () => {
      alertUserList.splice(idx, 1);
      renderAlertTags();
    };
    tagBox.appendChild(tag);
  });
}

// üìå ÏïåÎ¶º Ìå®ÎÑê ÏÉùÏÑ±
function createAlertPanel() {
  alertPanel = document.createElement('div');
  alertPanel.id = 'poong-alert-panel';
  alertPanel.style = `
    position:fixed;
    right:80px;
    bottom:80px;
    width:360px;
    background:#f9fafb;
    border:1px solid #d1d5db;
    border-radius:12px;
    box-shadow:0 10px 25px rgba(0,0,0,0.1);
    font-family: 'Segoe UI','Pretendard',sans-serif;
    z-index:2147483647;
    overflow:hidden;
    display:none;
  `;

  alertPanel.innerHTML = `
    <div class="panel-header">üîî ÏïåÎ¶º ÏÑ§Ï†ï</div>
    <div class="panel-body">
      <div class="setting-group">
        <label>ÏïåÎ¶º ÏÇ¨Ïö©</label>
        <div class="toggle-wrap">
          <label class="toggle-switch">
            <input type="checkbox" id="alert-enabled"><span class="slider"></span>
          </label>
        </div>
      </div>
      <div class="setting-group">
        <label>Í∏∞Í∞Ñ ÏÑ§Ï†ï</label>
        <div class="input-row">
          <input type="date" id="alert-start">
          <input type="date" id="alert-end">
        </div>
        <div class="range-buttons">
          <button data-range="1">ÌïòÎ£®</button>
          <button data-range="7">ÏùºÏ£ºÏùº</button>
          <button data-range="30">ÌïúÎã¨</button>
          <button data-range="365">ÏùºÎÖÑ</button>
        </div>
      </div>
      <div class="setting-group">
        <label>Î≥ÑÌíçÏÑ† ÌïÑÌÑ∞</label>
        <input type="number" id="alert-stars" placeholder="Ïòà: 10000">
      </div>
      <div class="setting-group">
        <label>ID ÏàòÎèô Ï∂îÍ∞Ä</label>
        <div class="tag-list" id="alert-tags"></div>
        <div class="add-id">
          <input type="text" id="alert-id-input" placeholder="Ïú†Ï†Ä ID ÏûÖÎ†•">
          <button id="add-id-btn">+ Ï∂îÍ∞Ä</button>
        </div>
      </div>
    </div>
    <div class="panel-footer">
      <button class="cancel">Ï∑®ÏÜå</button>
      <button class="apply" id="save-alert-settings">Ï†ÄÏû•</button>
    </div>
  `;
  document.body.appendChild(alertPanel);

  // ÎÇ†Ïßú Î≤ÑÌäº Ï≤òÎ¶¨
  alertPanel.querySelectorAll('.range-buttons button').forEach(btn => {
    btn.onclick = () => {
      const range = parseInt(btn.dataset.range);
      const end = new Date();
      const start = new Date(end);
      start.setDate(end.getDate() - (range - 1));
      alertPanel.querySelector('#alert-start').value = start.toISOString().split('T')[0];
      alertPanel.querySelector('#alert-end').value = end.toISOString().split('T')[0];
    };
  });

  alertPanel.querySelector('#add-id-btn').onclick = () => {
    const input = alertPanel.querySelector('#alert-id-input');
    const id = input.value.trim();
    if (id && !alertUserList.includes(id)) {
      alertUserList.push(id);
      renderAlertTags();
      input.value = '';
    }
  };

  alertPanel.querySelector('.cancel').onclick = () => {
    alertPanel.style.display = 'none';
  };

  alertPanel.querySelector('.apply').onclick = () => {
    console.log('‚úÖ [ÏïåÎ¶º] Ï†ÄÏû• Î≤ÑÌäº ÌÅ¥Î¶≠Îê®');
    const enabled = alertPanel.querySelector('#alert-enabled').checked;
    const start = alertPanel.querySelector('#alert-start').value;
    const end = alertPanel.querySelector('#alert-end').value;
    const minStars = parseInt(alertPanel.querySelector('#alert-stars').value) || 0;
    const manualIds = [...alertUserList];
  
    console.log('‚è≥ ÏàòÎèô ID Î™©Î°ù:', manualIds);
    console.log('‚è≥ ÎÇ†ÏßúÎ≤îÏúÑ:', start, '~', end);
    console.log('‚è≥ Î≥ÑÌíçÏÑ† ÌïÑÌÑ∞:', minStars);
  
    chrome.storage.local.get(['poong_donation_by_date'], ({ poong_donation_by_date }) => {
      if (!poong_donation_by_date) {
        alert('‚ùå poong_donation_by_date ÏóÜÏùå');
        return;
      }
  
      const matchedIds = new Set();
  
      const toDateObj = str => {
        const [y, m = '1', d = '1'] = str.split(/[^\d]/).map(Number);
        return new Date(y, m - 1, d);
      };
  
      const startDate = toDateObj(start);
      const endDate = toDateObj(end);
  
      Object.entries(poong_donation_by_date).forEach(([rawDate, entries]) => {
        const parts = rawDate.split(/[^\d]/).filter(Boolean);
        const y = parseInt(parts[0] || '0', 10);
        const m = parseInt(parts[1] || '1', 10) - 1;
        const d = parseInt(parts[2] || '1', 10);
        const dateObj = new Date(y, m, d);
  
        if (dateObj >= startDate && dateObj <= endDate) {
          entries.forEach(entry => {
            const id = (entry.user_id || entry.userId || '').trim();
            let raw = entry.totalStars ?? entry.stars ?? '0';
  
            // Í∞ùÏ≤¥ ÌòïÌÉú ÎåÄÏùë
            if (typeof raw === 'object' && raw !== null) raw = raw.v ?? '0';
  
            const str = typeof raw === 'string' ? raw : raw.toString();
            let normalized = str.replace(/,/g, '').replace(/[^\d]/g, '');
  
            // "Îßå" Îã®ÏúÑ Ï≤òÎ¶¨
            if (/Îßå/.test(str)) {
              const num = parseFloat(str.replace(/[^\d.]/g, '')) || 0;
              normalized = Math.round(num * 10000).toString();
            }
  
            const stars = parseInt(normalized, 10) || 0;
            if (id && stars >= minStars) matchedIds.add(id);
          });
        }
      });
  
      manualIds.forEach(id => matchedIds.add(id));
      const finalIds = [...matchedIds];
  
      console.log('‚úÖ ÏµúÏ¢Ö Í∞êÏãú ID Î™©Î°ù:', finalIds);
  
      chrome.storage.local.set({
        poong_alert_config: {
          enabled,
          start,
          end,
          minStars,
          ids: finalIds,
          manualIds: manualIds
        }
      }, () => {
        alert(
          `‚úÖ Ï†ÄÏû•Îê®\n` +
          `Ï¥ù ${finalIds.length}Î™Ö Í∞êÏãú ÏÑ§Ï†ïÎê®\n\n` +
          `[Í∞êÏãú ÎåÄÏÉÅ ID]\n${finalIds.join('\n')}\n\n` +
          `[Í∏∞Í∞Ñ] ${start} ~ ${end}\n` +
          `[Î≥ÑÌíçÏÑ† ÌïÑÌÑ∞] ${minStars}Í∞ú Ïù¥ÏÉÅ`
        );
      });
    });
  };
}

// üîî ÏïÑÏù¥ÏΩò ÌÅ¥Î¶≠ Ïãú Ìå®ÎÑê ÌëúÏãú
alertIcon.onclick = () => {
  if (!alertPanel) createAlertPanel();
  showAlertPanel();
};

// (ÎîîÎ≤ÑÍ∑∏Ïö©) 7Ïõî Îç∞Ïù¥ÌÑ∞ Ï∂úÎ†•
chrome.storage.local.get('poong_donation_by_date', r => {
  const data = r?.poong_donation_by_date || {};
  const result = [];

  for (const [rawDate, arr] of Object.entries(data)) {
    const normalized = rawDate.replace(/\s/g, '');
    if (/^2025\.?0?7(\.|$)/.test(normalized)) {
      result.push(...arr);
    }
  }

  console.log(`[Poong] ‚úÖ 7Ïõî Ï†ÑÏ≤¥ ÌõÑÏõêÏûê Ïàò: ${result.length}`);
  console.log(`[Poong] ‚úÖ 7Ïõî Ï†ÑÏ≤¥ ÌõÑÏõêÏûê Î™©Î°ù:`, result);
});
const script = document.createElement('script');
script.src = chrome.runtime.getURL('injected.js');
(document.head || document.documentElement).appendChild(script);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ÏûêÎèô GitHub Î°úÎìú  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BASE_URL = 'https://raw.githubusercontent.com/ksh8741/poongtoo/main/';
const INDEX_URL = BASE_URL + 'index.json';

(async function autoImportFromIndex() {
  const STORAGE_KEY = 'poong_donation_by_date';

  const existing = await new Promise(r =>
    chrome.storage.local.get(STORAGE_KEY, res => r(res[STORAGE_KEY] || {}))
  );
  const savedDates = new Set(Object.keys(existing));

  try {
    const indexRes = await fetch(INDEX_URL);
    const index = await indexRes.json();

    const missingDates = index.filter(date => !savedDates.has(date));
    if (missingDates.length === 0) return;

    for (const date of missingDates) {
      const clean = date.replace(/\./g, '').replace(/\s/g, '');
      const fileUrl = `${BASE_URL}${clean}.json`;  // ‚Üê date/ Ï†úÍ±∞Îê®

      try {
        const res = await fetch(fileUrl);
        if (!res.ok) throw new Error('File not found');
        const data = await res.json();
        existing[date] = data;
      } catch (err) {
        console.warn(`‚ùå ${date} Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®`, err);
      }
    }

    chrome.storage.local.set({ [STORAGE_KEY]: existing }, () => {
      console.log(`‚úÖ ÏûêÎèô Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å (${missingDates.length}Í∞ú)`);
      renderPoongUI(existing);
    });

  } catch (err) {
    console.warn('‚ùå index.json Î°úÎî© Ïã§Ìå®', err);
  }
})();
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ÏûêÎèô GitHub Î°úÎìú ÎÅù ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
})();